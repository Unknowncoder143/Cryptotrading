<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect and Token Swap</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
</head>
<body>
    <h1>Wallet Connection & Token Swap</h1>

    <!-- Connect Wallet Section -->
    <button id="connectButton" onclick="connectWallet()">Connect Wallet</button>
    <p id="walletStatus">Not connected</p>

    <hr>

    <!-- Pool Information -->
    <h2>Uniswap Pool Details</h2>
    <label for="network">Network: </label>
    <select id="network">
        <option value="polygon">Polygon</option>
        <option value="ethereum">Ethereum</option>
        <option value="bsc">Binance Smart Chain</option>
    </select>
    <br><br>
    <label for="poolAddress">Pool Address: </label>
    <input type="text" id="poolAddress" placeholder="Enter Pool Address" />
    <br><br>
    <button onclick="fetchReserves()">Fetch Reserves</button>
    <div id="reservesResult"></div>

    <hr>

    <!-- Token Swap Section -->
    <h2>Token Swap</h2>
    <label for="amount">Amount to Swap: </label>
    <input type="number" id="amount" placeholder="Amount" />
    <br><br>
    <label for="direction">Swap Direction: </label>
    <select id="direction">
        <option value="0">USDT → WBTC</option>
        <option value="1">WBTC → USDT</option>
    </select>
    <br><br>
    <button onclick="executeSwap()">Execute Swap</button>

    <div id="transactionResult"></div>

    <script>
        let web3;
        let userAccount;

        // Function to connect wallet
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    document.getElementById('walletStatus').innerText = `Connected: ${userAccount}`;
                    document.getElementById('connectButton').innerText = 'Wallet Connected';
                } catch (error) {
                    alert('Connection failed. Try again.');
                }
            } else {
                alert('Please install MetaMask or a compatible wallet.');
            }
        }

        // Function to fetch reserves from the Uniswap pool
        async function fetchReserves() {
            const network = document.getElementById('network').value;
            const poolAddress = document.getElementById('poolAddress').value;

            // RPC URLs for different networks
            const rpcUrls = {
                polygon: "https://polygon-rpc.com",
                ethereum: "https://cloudflare-eth.com",
                bsc: "https://bsc-dataseed.binance.org/"
            };

            web3 = new Web3(new Web3.providers.HttpProvider(rpcUrls[network]));
            
            const poolAbi = [
                { "inputs": [], "name": "token0", "outputs": [{ "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
                { "inputs": [], "name": "token1", "outputs": [{ "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }
            ];

            const erc20Abi = [
                { "constant": true, "name": "balanceOf", "inputs": [{ "name": "_owner", "type": "address" }], "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
                { "constant": true, "name": "decimals", "inputs": [], "outputs": [{ "name": "", "type": "uint8" }], "type": "function" }
            ];

            try {
                const poolContract = new web3.eth.Contract(poolAbi, poolAddress);
                const token0Address = await poolContract.methods.token0().call();
                const token1Address = await poolContract.methods.token1().call();

                const token0 = new web3.eth.Contract(erc20Abi, token0Address);
                const token1 = new web3.eth.Contract(erc20Abi, token1Address);

                const [balance0, decimals0] = await Promise.all([
                    token0.methods.balanceOf(poolAddress).call(),
                    token0.methods.decimals().call()
                ]);

                const [balance1, decimals1] = await Promise.all([
                    token1.methods.balanceOf(poolAddress).call(),
                    token1.methods.decimals().call()
                ]);

                const reserve0 = Number(balance0) / (10 ** decimals0);
                const reserve1 = Number(balance1) / (10 ** decimals1);

                const wbtcReserve = decimals0 === "8" ? reserve0 : reserve1;
                const usdtReserve = decimals0 === "6" ? reserve0 : reserve1;

                document.getElementById('reservesResult').innerHTML = `
                    WBTC Reserve: ${wbtcReserve}<br>
                    USDT Reserve: ${usdtReserve}
                `;
            } catch (error) {
                document.getElementById('reservesResult').innerText = 'Error fetching reserves.';
            }
        }

        // Function to execute token swap
        async function executeSwap() {
            if (!userAccount) {
                alert('Please connect your wallet first.');
                return;
            }

            const poolAddress = document.getElementById('poolAddress').value;
            const amount = document.getElementById('amount').value;
            const direction = document.getElementById('direction').value;

            const poolAbi = [
                { "inputs": [{ "name": "amount", "type": "uint256" }], "name": "swap", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
            ];

            const poolContract = new web3.eth.Contract(poolAbi, poolAddress);

            try {
                const tx = await poolContract.methods.swap(web3.utils.toWei(amount, 'ether')).send({ from: userAccount });
                document.getElementById('transactionResult').innerHTML = `
                    Swap Executed!<br>
                    Transaction Hash: <a href="https://etherscan.io/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a>
                `;
            } catch (error) {
                document.getElementById('transactionResult').innerText = 'Error executing swap.';
            }
        }
    </script>
</body>
</html>
