<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>USDT to WBTC Secure Swap</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
</head>
<body style="font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px;">
  <h2>Swap USDT to WBTC</h2>

  <label>USDT Amount:</label><br>
  <input type="number" id="amount" placeholder="Enter USDT amount" /><br><br>

  <label>Pool Contract Address:</label><br>
  <input type="text" id="poolAddress" placeholder="0x..." /><br><br>

  <button onclick="connectWallet()">Connect Wallet</button>
  <button onclick="previewTransaction()">Preview Transaction</button>
  <button onclick="signTransaction()" id="signButton" style="display:none;">Sign & Confirm</button>
  <button onclick="executeSwap()" id="swapButton" style="display:none;">Execute Swap</button>

  <div id="previewBox" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none;"></div>
  <p id="result" style="margin-top: 20px;"></p>

  <script>
    let web3;
    let userAddress;

    const erc20Abi = [
      {
        constant: false,
        inputs: [
          { name: "_spender", type: "address" },
          { name: "_value", type: "uint256" }
        ],
        name: "approve",
        outputs: [{ name: "success", type: "bool" }],
        type: "function"
      }
    ];

    const swapAbi = [
      {
        constant: false,
        inputs: [{ name: "amountIn", type: "uint256" }],
        name: "swapUSDTForWBTC",
        outputs: [],
        stateMutability: "nonpayable",
        type: "function"
      }
    ];

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];
        document.getElementById("result").innerText = `Wallet connected: ${userAddress}`;
      } else {
        alert("Install MetaMask!");
      }
    }

    function previewTransaction() {
      const amount = document.getElementById("amount").value;
      const poolAddress = document.getElementById("poolAddress").value;

      if (!amount || !poolAddress) {
        alert("Please enter amount and pool address.");
        return;
      }

      const preview = `
        <strong>Transaction Preview:</strong><br>
        Swap <strong>${amount}</strong> USDT<br>
        To Pool: <strong>${poolAddress}</strong><br><br>
        You will now sign this data before confirming.
      `;
      document.getElementById("previewBox").innerHTML = preview;
      document.getElementById("previewBox").style.display = "block";
      document.getElementById("signButton").style.display = "inline-block";
    }

    async function signTransaction() {
      const amount = document.getElementById("amount").value;
      const poolAddress = document.getElementById("poolAddress").value;
      const amountInUSDT = parseFloat(amount).toFixed(2);

      const msgParams = JSON.stringify({
        domain: {
          chainId: 1,
          name: 'USDT to WBTC Swap',
          verifyingContract: poolAddress,
          version: '1',
        },
        message: {
          sender: userAddress,
          token: 'USDT',
          amount: amountInUSDT,
          action: 'Swap to WBTC',
        },
        primaryType: 'Swap',
        types: {
          EIP712Domain: [
            { name: 'name', type: 'string' },
            { name: 'version', type: 'string' },
            { name: 'chainId', type: 'uint256' },
            { name: 'verifyingContract', type: 'address' },
          ],
          Swap: [
            { name: 'sender', type: 'address' },
            { name: 'token', type: 'string' },
            { name: 'amount', type: 'string' },
            { name: 'action', type: 'string' },
          ],
        },
      });

      try {
        const from = userAddress;
        const params = [from, msgParams];
        const method = 'eth_signTypedData_v4';

        await ethereum.request({ method, params });

        document.getElementById("result").innerText = "✅ Signed successfully! Now ready to swap.";
        document.getElementById("swapButton").style.display = "inline-block";
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "❌ Signing rejected or failed.";
      }
    }

    async function executeSwap() {
      const amount = document.getElementById("amount").value;
      const poolAddress = document.getElementById("poolAddress").value;
      const usdtAddress = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // Mainnet USDT

      const amountInWei = web3.utils.toBN(amount * 1e6);
      const usdt = new web3.eth.Contract(erc20Abi, usdtAddress);
      const pool = new web3.eth.Contract(swapAbi, poolAddress);

      try {
        document.getElementById("result").innerText = "⏳ Approving USDT...";
        await usdt.methods.approve(poolAddress, amountInWei).send({ from: userAddress });

        document.getElementById("result").innerText = "⏳ Swapping now...";
        await pool.methods.swapUSDTForWBTC(amountInWei).send({ from: userAddress });

        document.getElementById("result").innerText = "✅ Swap successful!";
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "❌ Swap failed. Check console.";
      }
    }
  </script>
</body>
</html>
