<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WBTC/USDT Pool Swapper</title>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.55/dist/web3.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #eee;
      padding: 20px;
    }
    input, select, button {
      margin: 10px 0;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    input, select {
      width: 100%;
    }
    button {
      background: #f39c12;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #e67e22;
    }
    #details {
      white-space: pre-wrap;
      margin-top: 20px;
      background: #222;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>WBTC ↔ USDT Pool Swapper</h2>

  <button onclick="connectWallet()">Connect Wallet</button><br>

  <label>Pool Address</label>
  <input type="text" id="poolAddress" placeholder="Enter pool contract address">

  <label>Network</label>
  <select id="network">
    <option value="ethereum">Ethereum</option>
    <option value="polygon">Polygon</option>
    <option value="bsc">BSC</option>
  </select>

  <label>Amount</label>
  <input type="number" id="amount" placeholder="Enter amount">

  <label>Swap Direction</label>
  <select id="direction">
    <option value="usdtToWbtc">USDT → WBTC</option>
    <option value="wbtcToUsdt">WBTC → USDT</option>
  </select>

  <button onclick="executeSwap()">Swap</button>

  <div id="details"></div>

  <script>
    let web3;
    let userAddress;

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAddress = accounts[0];
          document.getElementById("details").innerText = "Connected: " + userAddress;
        } catch (error) {
          console.error("User rejected connection", error);
        }
      } else {
        alert("Please install MetaMask");
      }
    }

    async function executeSwap() {
      const poolAddress = document.getElementById("poolAddress").value;
      const amount = document.getElementById("amount").value;
      const network = document.getElementById("network").value;
      const direction = document.getElementById("direction").value;

      if (!web3 || !userAddress) {
        alert('Please connect your wallet first.');
        return;
      }

      const rpcUrls = {
        polygon: "https://polygon-rpc.com",
        ethereum: "https://cloudflare-eth.com",
        bsc: "https://bsc-dataseed.binance.org/"
      };
      const web3Provider = new Web3(new Web3.providers.HttpProvider(rpcUrls[network]));

      const erc20Abi = [
        { "constant": true, "name": "balanceOf", "inputs": [{ "name": "_owner", "type": "address" }], "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
        { "constant": true, "name": "decimals", "inputs": [], "outputs": [{ "name": "", "type": "uint8" }], "type": "function" }
      ];

      const poolAbi = [
        { "inputs": [], "name": "token0", "outputs": [{ "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "token1", "outputs": [{ "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
        {
          "constant": false,
          "inputs": [{ "name": "amountIn", "type": "uint256" }],
          "name": "swap",
          "outputs": [{ "name": "success", "type": "bool" }],
          "payable": true,
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ];

      const pool = new web3Provider.eth.Contract(poolAbi, poolAddress);
      const token0Addr = await pool.methods.token0().call();
      const token1Addr = await pool.methods.token1().call();

      const token0 = new web3Provider.eth.Contract(erc20Abi, token0Addr);
      const token1 = new web3Provider.eth.Contract(erc20Abi, token1Addr);

      const isWBTC0 = (await token0.methods.decimals().call()) === "8";
      const wbtcToken = isWBTC0 ? token0 : token1;
      const usdtToken = isWBTC0 ? token1 : token0;

      const [decWbtc, decUsdt] = await Promise.all([
        wbtcToken.methods.decimals().call(),
        usdtToken.methods.decimals().call()
      ]);

      const [wbtcBefore, usdtBefore] = await Promise.all([
        wbtcToken.methods.balanceOf(userAddress).call(),
        usdtToken.methods.balanceOf(userAddress).call()
      ]);

      const amountIn = direction === "usdtToWbtc"
        ? web3.utils.toBN(amount * (10 ** decUsdt))
        : web3.utils.toBN(amount * (10 ** decWbtc));

      try {
        const tx = await pool.methods.swap(amountIn).send({ from: userAddress });

        const [wbtcAfter, usdtAfter] = await Promise.all([
          wbtcToken.methods.balanceOf(userAddress).call(),
          usdtToken.methods.balanceOf(userAddress).call()
        ]);

        const wbtcChange = (wbtcAfter - wbtcBefore) / (10 ** decWbtc);
        const usdtChange = (usdtAfter - usdtBefore) / (10 ** decUsdt);

        document.getElementById("details").innerText =
          `Swap successful!\nTx Hash: ${tx.transactionHash}\n\n` +
          `WBTC: ${(wbtcBefore / 10 ** decWbtc).toFixed(8)} → ${(wbtcAfter / 10 ** decWbtc).toFixed(8)} ` +
          `(${wbtcChange >= 0 ? "+" : ""}${wbtcChange.toFixed(8)})\n` +
          `USDT: ${(usdtBefore / 10 ** decUsdt).toFixed(2)} → ${(usdtAfter / 10 ** decUsdt).toFixed(2)} ` +
          `(${usdtChange >= 0 ? "+" : ""}${usdtChange.toFixed(2)})`;

      } catch (err) {
        console.error('Swap failed:', err);
        document.getElementById("details").innerText = `Swap failed: ${err.message}`;
      }
    }
  </script>
</body>
</html>
